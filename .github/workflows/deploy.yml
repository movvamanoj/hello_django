name: Continuous Integration and Deployment (Ubuntu EC2)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Codebase
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Analyze Code Quality with SonarQube
        uses: sonarsource/sonarqube-scan-action@master
        with:
          projectKey: hello_django
          organization: JHC
          login: ${{ secrets.SONAR_TOKEN }}
          sonar.host.url: ${{ secrets.SONAR_HOST_URL }}

      - name: Deploy to Ubuntu EC2 (if SonarQube analysis succeeds)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          if: ${{ steps.analyze.outputs.success }}
          script: |
            git clone https://github.com/movvamanoj/hello_django.git
            sudo apt update -y
            sudo apt install python3-venv -y
            python3 -m venv ./venv
            source ./venv/bin/activate
            cd hello_django
            pip install -r requirements.txt
            python3 manage.py migrate
            nohup python3 manage.py runserver 0.0.0.0:8000 > server.log 2>&1 &
